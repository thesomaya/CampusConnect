import { useNavigation } from '@react-navigation/native';
import React, { useEffect, useState } from 'react';
import { ActivityIndicator, Alert, Image, Text } from 'react-native';
import { useSelector } from 'react-redux';

const JoinChatScreen = ({ route }) => {
  const navigation = useNavigation();
  const storedChats = useSelector(state => state.chats.chatsData);
  const { invitationCode } = route.params;
  const [chatData, setChatData] = useState(null);

  useEffect(() => {
    const foundChatData = Object.values(storedChats).find(chat => chat.invitationCode === invitationCode);
    if (foundChatData) {
      setChatData(foundChatData);
    } else {
      console.log('Chat not found');
      navigation.goBack(); 
    }
  }, [storedChats, invitationCode, navigation]);

  const handleCancel = () => {
    navigation.goBack(); 
  };

  const handleJoin = () => {
    navigation.navigate('ChatScreen', { chatId: chatData.key });
  };

  const showJoinConfirmationAlert = () => {
    Alert.alert(
      'Join Chat',
      `Do you want to join the chat: ${chatData.chatName}?`,
      [
        {
          text: 'Cancel',
          onPress: handleCancel,
          style: 'cancel',
        },
        {
          text: 'Join',
          onPress: handleJoin,
        },
      ],
      {
        cancelable: false,
      }
    );
  };

  return (
    <>
      {chatData !== null ? (
        <>
          {showJoinConfirmationAlert()}
          {/* The rest of your component using chatData. */}
          <Image
            source={{ uri: chatData.chatImage }}
            style={{ width: 50, height: 50, borderRadius: 25, marginBottom: 10 }}
          />
          <Text>{chatData.chatName}</Text>
          <Text>{`Joining chat with invitation code: ${invitationCode}`}</Text>
          {/* The rest of your component */}
        </>
      ) : (
        // Show loading indicator or any other UI while chatData is being fetched
        <ActivityIndicator size='large' color='blue' />
      )}
    </>
  );
};


export default JoinChatScreen;
